[workspace]
allow_dirty = true
changelog_update = true
dependencies_update = false
git_release_enable = false
git_release_body = """
{{ changelog }}
{% if remote.contributors %}
### è´¡çŒ®è€…
{% for contributor in remote.contributors %}
* @{{ contributor.username }}
{% endfor %}
{% endif %}
"""
git_tag_enable = false
pr_branch_prefix = "release-"
pr_labels = ["release"]
publish_allow_dirty = false
semver_check = false
publish_timeout = "10m"
release_commits = "^feat:"
pr_body = """
{% macro get_changes(releases, type="text") %}
{%- for release in releases %}
{%- if release.title and release.changelog %}{% if releases | length > 1 %}
## `{{ release.package }}`
{% endif %}
<blockquote>

## {{ release.title }}

{{ release.changelog }}
</blockquote>{% endif %}
{% endfor %}
{% endmacro -%}

{% set changes = self::get_changes(releases=releases) %}

## ğŸ¤– æ–°ç‰ˆæœ¬å‘å¸ƒ
{% for release in releases %}
* `{{ release.package }}`: {% if release.previous_version and release.previous_version != release.next_version %}{{ release.previous_version }} -> {% endif %}{{ release.next_version }}{% if release.semver_check == "incompatible" %} (âš  API ç ´åæ€§å˜æ›´){% elif release.semver_check == "compatible" %} (âœ“ API å…¼å®¹æ€§å˜æ›´){% endif %}
{%- endfor %}
{%- for release in releases %}{% if release.breaking_changes %}

### âš  `{{ release.package }}` ç ´åæ€§å˜æ›´

```text
{{ release.breaking_changes }}
```{% endif %}{% endfor %}
{% if changes %}
<details><summary><i><b>å˜æ›´æ—¥å¿—</b></i></summary><p>
{{ changes }}
</p></details>
{% endif %}
---
"""
publish = true


[changelog]
header = """# å˜æ›´æ—¥å¿—
"""

body = """
{%- macro print_commit(commit) -%}
    - {% if commit.scope %}*({{ commit.scope }})* {% endif %}\
      {% if commit.breaking %}[**breaking**] {% endif %}\
      {{ commit.message | upper_first }}{{ self::username(commit=commit) }}{{ self::pr(commit=commit) }} - \
      ([{{ commit.id | truncate(length=7, end="") }}]({{ remote.link }}/commit/{{ commit.id }}))
{%- endmacro -%}

{%- macro username(commit) -%}
    {% if commit.remote.username %} (ç”± @{{ commit.remote.username }} æä¾›){% endif -%}
{%- endmacro -%}

{%- macro pr(commit) -%}
    {% if commit.remote.pr_number %} (#{{ commit.remote.pr_number }}){% endif -%}
{%- endmacro -%}

## [{{ version }}]\
{% if release_link %}({{ release_link }}){% endif %} - {{ timestamp | date(format="%Y-%m-%d") }}

{% for group, commits in commits
| filter(attribute="merge_commit", value=false)
| group_by(attribute="group") %}
### {{ group | striptags | trim | upper_first }}

{% for commit in commits | unique(attribute="message") | filter(attribute="scope") | sort(attribute="scope") %}
{{ self::print_commit(commit=commit) }}
{%- endfor %}
{% for commit in commits | unique(attribute="message") %}
{%- if not commit.scope %}
{{ self::print_commit(commit=commit) }}
{%- endif %}
{%- endfor %}

{% endfor %}
{%- if remote.contributors %}

### è´¡çŒ®è€…
{% for contributor in remote.contributors %}
* @{{ contributor.username }}
{%- endfor %}
{% endif %}
"""

commit_parsers = [
    { message = "^feat", group = "<!-- 0 -->â›°ï¸ æ–°åŠŸèƒ½" },
    { message = "^fix", group = "<!-- 1 -->ğŸ› Bug ä¿®å¤" },
    { message = "^doc", group = "<!-- 3 -->ğŸ“š æ–‡æ¡£" },
    { message = "^perf", group = "<!-- 4 -->âš¡ æ€§èƒ½ä¼˜åŒ–" },
    { message = "^refactor\\(clippy\\)", skip = true },
    { message = "^refactor", group = "<!-- 2 -->ğŸšœ é‡æ„" },
    { message = "^style", group = "<!-- 5 -->ğŸ¨ æ ·å¼" },
    { message = "^test", group = "<!-- 6 -->ğŸ§ª æµ‹è¯•" },
    { message = "^chore\\(release\\):", skip = true },
    { message = "^chore: release", skip = true },
    { message = "^chore\\(deps.*\\)", skip = true },
    { message = "^chore\\(pr\\)", skip = true },
    { message = "^chore\\(pull\\)", skip = true },
    { message = "^chore\\(npm\\).*yarn\\.lock", skip = true },
    { message = "^chore|^ci", group = "<!-- 7 -->âš™ï¸ æ‚é¡¹" },
    { body = ".*security", group = "<!-- 8 -->ğŸ›¡ï¸ å®‰å…¨" },
    { message = "^revert", group = "<!-- 9 -->â—€ï¸ å›é€€" },
]

link_parsers = [
    { pattern = "#(\\d+)", href = "{{ remote.link }}/issues/$1" },
    { pattern = "RFC(\\d+)", text = "ietf-rfc$1", href = "https://datatracker.ietf.org/doc/html/rfc$1" },
]

[[package]]
name = "puniyu"
git_release_enable = true
git_tag_enable = true
publish = false

[[package]]
name = "puniyu_core"
git_tag_enable = true

[[package]]
name = "puniyu_plugin"
git_tag_enable = true

[[package]]
name = "puniyu_adapter"
git_tag_enable = true

[[package]]
name = "puniyu_adapter_console"
git_tag_enable = true

[[package]]
name = "puniyu_server"
git_tag_enable = true

[[package]]
name = "puniyu_build"
git_tag_enable = true

[[package]]
name = "puniyu_common"
git_tag_enable = true

[[package]]
name = "puniyu_config"
git_tag_enable = true

[[package]]
name = "puniyu_library"
git_tag_enable = true

[[package]]
name = "puniyu_types"
git_tag_enable = true

[[package]]
name = "puniyu_macros"
git_tag_enable = true

[[package]]
name = "puniyu_registry"
git_tag_enable = true

[[package]]
name = "puniyu_matcher_command"
git_tag_enable = true

[[package]]
name = "puniyu_handler_command"
git_tag_enable = true

[[package]]
name = "puniyu_bus"
git_tag_enable = true
