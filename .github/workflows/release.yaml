name: release
on:
  push:
    branches:
      - main
  pull_request_target:
  workflow_dispatch:


env:
  APP_NAME: puniyu

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true


jobs:
  release:
    if: "!startsWith(github.head_ref, 'release')"
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release-plz.outputs.releases_created }}
      puniyu: ${{ steps.parse-releases.outputs.puniyu }}
      tag_name: ${{ steps.parse-releases.outputs.tag_name }}
    steps:
      - name: 获取token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: 检出仓库
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0
          persist-credentials: true

      - name: 设置 rust
        uses: puniyu/setup-rust@main
        with:
          tools: just
          save-cache: true
          prefix-key: ${{ env.APP_NAME }}

      - name: 单元测试
        run: |
          just test

      - name: 运行 release-plz
        id: release-plz
        uses: release-plz/action@1efcf74dfcd6e500990dad806e286899ae384064 # v0.5
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_API_TOKEN }}

      - name: 解析 releases
        id: parse-releases
        if: steps.release-plz.outputs.releases_created == 'true'
        run: |
          releases='${{ steps.release-plz.outputs.releases }}'
          puniyu=$(echo "$releases" | jq -r '.[] | select(.package_name == "puniyu") | .package_name // empty')
          tag_name=$(echo "$releases" | jq -r '.[] | select(.package_name == "puniyu") | .tag // empty')
          echo "puniyu=$puniyu" >> $GITHUB_OUTPUT
          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT


  test:
    if: "!startsWith(github.head_ref, 'release')"
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6

      - name: 设置 rust
        uses: puniyu/setup-rust@main
        with:
          tools: just
          save-cache: true
          prefix-key: ${{ env.APP_NAME }}

      - name: 单元测试
        run: |
          just test

  build:
    needs: release
    uses: ./.github/workflows/build.yaml
    with:
      stable: ${{ needs.release.outputs.releases_created == 'true' }}

  publish-github-release:
    needs: [ release, build ]
    if: ${{ needs.release.outputs.puniyu }}
    runs-on: ubuntu-latest
    steps:
      - name: 获取token
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: 下载构建产物
        uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5 # v11
        with:
          name: "^${{ env.APP_NAME }}.*"
          name_is_regexp: true
          skip_unpack: true

      - name: 上传Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          files: |
            ${{ env.APP_NAME }}-*
          tag_name: ${{ needs.release.outputs.tag_name }}